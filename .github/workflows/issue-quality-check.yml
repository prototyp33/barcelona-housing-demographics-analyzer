name: Issue Quality Check

on:
  issues:
    types: [opened, edited]

# Evitar mÃºltiples checks para la misma issue
concurrency:
  group: issue-quality-${{ github.event.issue.number }}
  cancel-in-progress: true

jobs:
  validate:
    runs-on: ubuntu-latest
    steps:
      - name: Check issue quality
        uses: actions/github-script@v7
        with:
          script: |
            const body = context.payload.issue.body || '';
            const issueNumber = context.payload.issue.number;
            const title = context.payload.issue.title || '';
            
            const issues = [];
            const warnings = [];
            
            // Verificar criterios de aceptaciÃ³n
            const hasAcceptance = /##.*âœ….*DefiniciÃ³n de Hecho|##.*Criterios de AceptaciÃ³n|##.*Definition of Done/i.test(body);
            if (!hasAcceptance) {
              issues.push('âŒ Falta secciÃ³n "Criterios de AceptaciÃ³n" o "Definition of Done"');
            }
            
            // Verificar estimaciÃ³n de tiempo
            const hasEstimate = /\d+\s*(horas?|dÃ­as?|minutos?)/i.test(body) || /â±ï¸|EstimaciÃ³n|estimated/i.test(body);
            if (!hasEstimate) {
              issues.push('âŒ Falta estimaciÃ³n de tiempo (ej: "2 horas", "30 minutos")');
            }
            
            // Verificar que tenga checkboxes en criterios
            const hasCheckboxes = /- \[ \]/.test(body);
            if (!hasCheckboxes) {
              warnings.push('âš ï¸ No se encontraron checkboxes en criterios de aceptaciÃ³n');
            }
            
            // Verificar formato de tÃ­tulo para issues principales (no sub-issues)
            const isSubIssue = /\[SUB-ISSUE/i.test(title);
            if (!isSubIssue && !/\[(BUG|FEATURE|QUALITY|DATA|TEST|DOCS|REFACTOR)\]/i.test(title)) {
              warnings.push('âš ï¸ TÃ­tulo no sigue formato [TIPO] (recomendado: [BUG], [FEATURE], etc.)');
            }
            
            // Verificar descripciÃ³n del problema
            const hasDescription = /##.*ðŸ”.*DescripciÃ³n|##.*DescripciÃ³n del Problema/i.test(body);
            if (!hasDescription) {
              warnings.push('âš ï¸ Falta secciÃ³n "DescripciÃ³n del Problema"');
            }
            
            // Si hay problemas, aÃ±adir label y comentario
            if (issues.length > 0 || warnings.length > 0) {
              // AÃ±adir label si no existe
              try {
                await github.rest.issues.addLabels({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: issueNumber,
                  labels: ['needs-refinement']
                });
              } catch (e) {
                // Label puede no existir, continuar
                console.log('Label needs-refinement puede no existir');
              }
              
              // Crear comentario con feedback
              let comment = '## ðŸ“‹ RevisiÃ³n de Calidad de Issue\n\n';
              
              if (issues.length > 0) {
                comment += '### âŒ Problemas que deben corregirse:\n\n';
                issues.forEach(issue => {
                  comment += `- ${issue}\n`;
                });
                comment += '\n';
              }
              
              if (warnings.length > 0) {
                comment += '### âš ï¸ Recomendaciones:\n\n';
                warnings.forEach(warning => {
                  comment += `- ${warning}\n`;
                });
                comment += '\n';
              }
              
              comment += '---\n\n';
              comment += 'ðŸ“š **Recursos:**\n';
              comment += '- [Mejores PrÃ¡cticas de Issues](docs/BEST_PRACTICES_GITHUB_ISSUES.md)\n';
              comment += '- [Template de Issue](.github/ISSUE_TEMPLATE.md)\n';
              
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issueNumber,
                body: comment
              });
            } else {
              // Issue cumple con las mejores prÃ¡cticas
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issueNumber,
                body: 'âœ… Esta issue cumple con las mejores prÃ¡cticas del proyecto. Â¡Gracias por seguir el template!'
              });
            }

