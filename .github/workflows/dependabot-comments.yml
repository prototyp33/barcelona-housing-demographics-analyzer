# ==============================================================================
# Dependabot PR Comments
# ==============================================================================
# AÃ±ade comentarios informativos automÃ¡ticos en PRs de Dependabot con:
# - Enlaces a changelogs cuando estÃ¡n disponibles
# - InformaciÃ³n sobre el tipo de actualizaciÃ³n (major/minor/patch)
# - Recomendaciones de testing
# - Enlaces a documentaciÃ³n de migraciÃ³n si es major update
#
# CONFIGURACIÃ“N:
# - Se ejecuta cuando se abre o actualiza un PR de Dependabot
# - Extrae informaciÃ³n del tÃ­tulo y body del PR
# - Busca changelogs en repositorios comunes (pypi, github)
# ==============================================================================

name: Dependabot PR Comments

on:
  pull_request:
    types: [opened, synchronize]
    paths:
      - 'requirements*.txt'
      - '.github/scripts/requirements.txt'
      - '.github/workflows/**/*.yml'
      - 'Dockerfile'
      - 'docker-compose.yml'

permissions:
  pull-requests: write
  contents: read

jobs:
  add-info-comment:
    name: ğŸ’¬ Add Dependency Info
    runs-on: ubuntu-latest
    if: github.event.pull_request.user.login == 'dependabot[bot]'
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Extract dependency info
        id: deps
        uses: actions/github-script@v7
        with:
          script: |
            const pr = context.payload.pull_request;
            const title = pr.title;
            const body = pr.body || '';
            
            // Extraer nombre de dependencia y versiÃ³n
            const match = title.match(/Bump\s+([^\s]+)\s+from\s+([^\s]+)\s+to\s+([^\s]+)/i) ||
                         title.match(/Update\s+([^\s]+)\s+requirement\s+from\s+([^\s]+)\s+to\s+([^\s]+)/i);
            
            if (!match) {
              core.setOutput('has_info', 'false');
              return;
            }
            
            const [, packageName, oldVersion, newVersion] = match;
            
            // Detectar tipo de actualizaciÃ³n
            const isMajor = title.toLowerCase().includes('major') || 
                           title.toLowerCase().includes('version-update:semver-major');
            const isMinor = title.toLowerCase().includes('minor') || 
                           title.toLowerCase().includes('version-update:semver-minor');
            const isPatch = title.toLowerCase().includes('patch') || 
                           title.toLowerCase().includes('version-update:semver-patch');
            
            // Generar enlaces Ãºtiles
            const pypiLink = `https://pypi.org/project/${packageName}/`;
            const githubLink = `https://github.com/search?q=${encodeURIComponent(packageName)}`;
            
            // Buscar changelog comÃºn
            const changelogLinks = [
              `https://github.com/${packageName}/${packageName}/releases`,
              `https://pypi.org/project/${packageName}/${newVersion}/`,
            ];
            
            core.setOutput('has_info', 'true');
            core.setOutput('package_name', packageName);
            core.setOutput('old_version', oldVersion);
            core.setOutput('new_version', newVersion);
            core.setOutput('is_major', isMajor ? 'true' : 'false');
            core.setOutput('is_minor', isMinor ? 'true' : 'false');
            core.setOutput('is_patch', isPatch ? 'true' : 'false');
            core.setOutput('pypi_link', pypiLink);
            core.setOutput('github_link', githubLink);

      - name: Create informative comment
        if: steps.deps.outputs.has_info == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const packageName = '${{ steps.deps.outputs.package_name }}';
            const oldVersion = '${{ steps.deps.outputs.old_version }}';
            const newVersion = '${{ steps.deps.outputs.new_version }}';
            const isMajor = '${{ steps.deps.outputs.is_major }}' === 'true';
            const isMinor = '${{ steps.deps.outputs.is_minor }}' === 'true';
            const pypiLink = '${{ steps.deps.outputs.pypi_link }}';
            
            // Verificar si ya existe un comentario nuestro
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number
            });
            
            const botComment = comments.find(comment => 
              comment.user.type === 'Bot' && 
              comment.body.includes('ğŸ“¦ InformaciÃ³n de actualizaciÃ³n')
            );
            
            if (botComment) {
              console.log('â„¹ï¸  Comentario informativo ya existe');
              return;
            }
            
            // Construir mensaje
            let updateType = 'ğŸ”„ ActualizaciÃ³n';
            let updateTypeEmoji = 'ğŸ”„';
            let recommendations = '';
            
            if (isMajor) {
              updateType = 'âš ï¸ **ActualizaciÃ³n Major**';
              updateTypeEmoji = 'âš ï¸';
              recommendations = '### âš ï¸ Recomendaciones para Major Update:\n' +
                '- [ ] Revisar [changelog](' + pypiLink + ') para cambios breaking\n' +
                '- [ ] Ejecutar tests completos: `pytest tests/ -v`\n' +
                '- [ ] Verificar que el ETL funciona correctamente\n' +
                '- [ ] Revisar documentaciÃ³n de migraciÃ³n si estÃ¡ disponible\n' +
                '- [ ] Probar funcionalidades crÃ­ticas manualmente';
            } else if (isMinor) {
              updateType = 'âœ¨ ActualizaciÃ³n Minor';
              updateTypeEmoji = 'âœ¨';
              recommendations = '### âœ… Recomendaciones para Minor Update:\n' +
                '- [ ] Ejecutar tests: `pytest tests/ -v`\n' +
                '- [ ] Verificar nuevas features si las hay';
            } else {
              updateType = 'ğŸ”§ ActualizaciÃ³n Patch';
              updateTypeEmoji = 'ğŸ”§';
              recommendations = '### âœ… Recomendaciones para Patch Update:\n' +
                '- [ ] Ejecutar tests bÃ¡sicos: `pytest tests/ -v`';
            }
            
            const comment = '## ' + updateTypeEmoji + ' InformaciÃ³n de actualizaciÃ³n\n\n' +
              '**Paquete:** `' + packageName + '`\n' +
              '**VersiÃ³n anterior:** `' + oldVersion + '`\n' +
              '**VersiÃ³n nueva:** `' + newVersion + '`\n' +
              '**Tipo:** ' + updateType + '\n\n' +
              '### ğŸ”— Enlaces Ãºtiles:\n' +
              '- ğŸ“¦ [PyPI: ' + packageName + '](' + pypiLink + ')\n' +
              '- ğŸ” [BÃºsqueda en GitHub](https://github.com/search?q=' + encodeURIComponent(packageName) + ')\n\n' +
              recommendations + '\n\n' +
              '---\n' +
              '*Este comentario se genera automÃ¡ticamente para ayudarte a revisar actualizaciones de dependencias.*';
            
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: comment
            });
            
            console.log(`âœ… Comentario informativo aÃ±adido para ${packageName}`);

