name: KPI Progress Update

on:
  issues:
    types: [closed]

jobs:
  update-kpis:
    runs-on: ubuntu-latest
    if: github.event.issue.state == 'closed'
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v6
      
    - name: Extract KPI from issue body
      id: extract-kpi
      run: |
        # Extrae el KPI objetivo del cuerpo de la issue
        BODY="${{ github.event.issue.body }}"
        KPI=$(echo "$BODY" | grep -i "KPI objetivo" | head -1 | sed 's/.*KPI objetivo[^:]*:\s*//' | head -c 100)
        echo "kpi=$KPI" >> $GITHUB_OUTPUT
        echo "Extracted KPI: $KPI"
        
    - name: Update KPI progress file
      run: |
        # Crea o actualiza el archivo de progreso de KPIs
        mkdir -p data
        FILE="data/kpi_progress.json"
        
        if [ ! -f "$FILE" ]; then
          echo '{"kpis": []}' > "$FILE"
        fi
        
        # Añade el KPI completado
        export ISSUE_NUM="${{ github.event.issue.number }}"
        export ISSUE_TITLE="${{ github.event.issue.title }}"
        export KPI="${{ steps.extract-kpi.outputs.kpi }}"
        export DATE=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
        
        python3 << EOF
        import json
        import os
        
        try:
            with open('$FILE', 'r') as f:
                data = json.load(f)
        except:
            data = {"kpis": []}
        
        issue_num_raw = os.environ.get("ISSUE_NUM")
        issue_title_raw = os.environ.get("ISSUE_TITLE", "")
        kpi_raw = os.environ.get("KPI", "")
        completed_at = os.environ.get("DATE", "")

        # Validar y convertir issue_number de forma segura
        issue_number = None
        if issue_num_raw:
            try:
                issue_number = int(issue_num_raw)
            except (ValueError, TypeError):
                # Si no es numérico válido, registrar error pero continuar
                print(f"Warning: Invalid issue number '{issue_num_raw}', storing as string")
                issue_number = str(issue_num_raw) if issue_num_raw else None

        # json.dump() maneja automáticamente el escape de caracteres especiales
        # No necesitamos escapar manualmente, Python lo hace correctamente
        new_entry = {
            "issue_number": issue_number,
            "issue_title": issue_title_raw or "",
            "kpi": kpi_raw or "",
            "completed_at": completed_at or "",
        }

        data["kpis"].append(new_entry)
        
        with open('$FILE', 'w') as f:
            json.dump(data, f, indent=2, ensure_ascii=False)
        
        print("KPI progress updated successfully")
        EOF
        
    - name: Commit and push KPI update
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        git add data/kpi_progress.json
        git commit -m "docs: Update KPI progress from issue #${{ github.event.issue.number }}" || exit 0
        git push || echo "No changes to commit"

