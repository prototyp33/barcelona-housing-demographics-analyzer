name: Dashboard Demo Generator

on:
  workflow_dispatch:
    inputs:
      issue_number:
        description: 'Issue number to attach screenshot to'
        required: true
        type: string
      port:
        description: 'Streamlit port (default 8501)'
        required: false
        default: '8501'
        type: string

jobs:
  generate-demo:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v6
      
    - name: Set up Python
      uses: actions/setup-python@v6
      with:
        python-version: '3.11'  # havia commit error: pandas 2.3.3 requiere Python 3.11 o superior
        
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements-dev.txt
        pip install playwright
        playwright install chromium
        
    - name: Start Streamlit server
      run: |
        streamlit run src/app/main.py --server.port ${{ inputs.port }} --server.headless true &
        sleep 10  # Esperar a que el servidor arranque
      env:
        PORT: ${{ inputs.port }}
        
    - name: Take screenshot
      run: |
        python -c "
        from playwright.sync_api import sync_playwright
        import time
        
        with sync_playwright() as p:
            browser = p.chromium.launch()
            page = browser.new_page()
            page.goto('http://localhost:${{ inputs.port }}')
            time.sleep(5)  # Esperar a que la pÃ¡gina cargue completamente
            page.screenshot(path='dashboard_screenshot.png', full_page=True)
            browser.close()
        "
        
    - name: Upload screenshot
      uses: actions/upload-artifact@v5
      with:
        name: dashboard-screenshot
        path: dashboard_screenshot.png
        
    - name: Comment on issue
      if: inputs.issue_number != ''
      uses: actions/github-script@v8
      with:
        script: |
          const fs = require('fs');
          const image = fs.readFileSync('dashboard_screenshot.png', 'base64');
          
          const issueNumber = parseInt('${{ inputs.issue_number }}', 10);
          if (isNaN(issueNumber)) {
            throw new Error(`Invalid issue number: ${{ inputs.issue_number }}`);
          }
          
          github.rest.issues.createComment({
            issue_number: issueNumber,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: 'ðŸ“¸ Screenshot del dashboard generado automÃ¡ticamente:\n\n![Dashboard](data:image/png;base64,' + image + ')'
          })

